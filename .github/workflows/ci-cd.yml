name: CI/CD

on:
    push:
        branches: ['main']
        tags: ['v*']
    pull_request:
        branches: ['main']

jobs:
    verify:
        name: Verify Code (PSScriptAnalyzer)
        runs-on: windows-latest
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Run PSScriptAnalyzer
              shell: powershell
              run: |
                  $results = Invoke-ScriptAnalyzer -Path ".\winget-updater-core" -Recurse -Severity Error,Warning
                  if ($results) {
                      $results | Format-Table
                      exit 1
                  }
                  Write-Host "PSScriptAnalyzer passed successfully."

    release:
        name: Create Release
        needs: verify
        if: startsWith(github.ref, 'refs/tags/')
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Create Zip Archive
              run: |
                  zip -r WinGet-Updater.zip install-winget-updater.bat winget-updater-core

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  files: WinGet-Updater.zip
                  draft: true
                  generate_release_notes: true
